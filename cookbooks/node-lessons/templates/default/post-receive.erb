#!/bin/sh
# post-receive.erb
# Generated by Chef for <%= node['hostname'] %>.
# Local modifications will be overwritten.
# This script is to be placed in /etc/init to work with upstart.

GIT_WORK_TREE=<%= @app_dir %>
export GIT_WORK_TREE

while read oldrev newrev ref
do
  branch=`echo $ref | cut -d/ -f3`
  echo current branch: $branch
  git --work-tree=$GIT_WORK_TREE checkout -f $branch
done

echo current work tree: $GIT_WORK_TREE
cd $GIT_WORK_TREE

sudo npm rebuild

restart <%= @service %>